<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Certificados MST</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Poppins:wght@300;400;600&family=Great+Vibes&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #004d99;
            --secondary-color: #ffd700;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --background-light: #f7f9fb;
            --background-card: #ffffff;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-light);
            color: #333;
        }

        .hidden {
            display: none !important;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), #0066cc);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-family: 'Playfair Display', serif;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #003366;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), #0066cc);
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            font-family: 'Playfair Display', serif;
            color: var(--primary-color);
            margin-bottom: 2rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .dashboard {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-family: 'Playfair Display', serif;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
            display: block;
        }

        table thead, table tbody {
            display: table;
            width: 100%;
        }

        table th, table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        table th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--primary-color);
        }

        table tr:hover {
            background: #f8f9fa;
        }

        /* CERTIFICADO HORIZONTAL */
        .certificate-wrapper {
            width: 100%;
            max-width: 1200px;
            aspect-ratio: 1.414 / 1;
            background-color: #fffff8;
            border: 1px solid #ddd;
            padding: 3%;
            position: relative;
            text-align: center;
            margin: 2rem auto;
            page-break-inside: avoid;
        }

        .certificate-wrapper::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            border: 5px solid var(--secondary-color);
            outline: 5px solid var(--primary-color);
            outline-offset: -15px;
        }

        .cert-company-name {
            position: absolute;
            top: 30px;
            left: 5%;
            font-size: 1.2em;
            font-weight: 700;
            color: var(--primary-color);
            letter-spacing: 2px;
            text-decoration: underline;
            text-decoration-color: var(--secondary-color);
            z-index: 2;
        }

        .cert-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5em;
            color: var(--primary-color);
            margin-top: 60px;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .cert-subtitle {
            font-size: 1em;
            color: #555;
            margin-bottom: 10px;
        }

        .cert-recipient {
            font-family: 'Playfair Display', serif;
            font-size: 2em;
            color: #000;
            margin: 5px 0 15px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--secondary-color);
            display: inline-block;
        }

        .cert-body-text {
            max-width: 75%;
            margin: 0 auto;
            font-size: 0.95em;
            color: #444;
            text-align: center;
            line-height: 1.6;
        }

        .cert-footer {
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            margin-top: 30px;
            padding: 0 10%;
            z-index: 2;
        }

        .cert-signature-block {
            text-align: center;
            position: relative;
            min-height: 120px;
        }

        .signature-image {
            position: absolute;
            cursor: move;
            max-width: 150px;
            max-height: 80px;
            user-select: none;
            z-index: 10;
            left: 50%;
            transform: translateX(-50%);
            top: -90px;
        }

        .signature-image.dragging {
            opacity: 0.7;
        }

        .signature-line {
            border-top: 2px solid #333;
            height: 1px;
            width: 200px;
            margin: 15px auto 5px auto;
        }

        .signature-name {
            font-weight: 600;
            font-size: 1em;
            color: var(--primary-color);
        }

        .signature-title {
            font-size: 0.85em;
            color: #777;
        }

        .cert-qr-block {
            position: absolute;
            bottom: 5%;
            right: 5%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            z-index: 2;
        }

        .qr-label {
            font-size: 0.7em;
            color: var(--primary-color);
            font-weight: 600;
            margin-top: 5px;
        }

        .cert-qr-block > div {
            width: 80px;
            height: 80px;
            padding: 5px;
            background: white;
            border: 2px solid var(--primary-color);
        }

        .file-upload-zone {
            border: 2px dashed #ddd;
            padding: 2rem;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-zone:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }

        .signature-upload-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .signature-upload-box {
            border: 2px dashed #ddd;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .signature-preview {
            max-width: 200px;
            max-height: 100px;
            margin: 1rem auto;
            display: block;
        }

        .verify-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            background-color: var(--background-light);
        }

        .verify-box {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 95%;
            width: 100%;
            text-align: center;
        }

        .verify-box h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }

        .certificate-info {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 2rem;
            text-align: left;
        }

        .certificate-info p {
            margin: 0.5rem 0;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .verification-link-box {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .verification-link-box input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.2rem;
            }
            
            .cert-title { 
                font-size: 1.8em; 
                margin-top: 50px; 
            }
            
            .cert-recipient { 
                font-size: 1.5em; 
            }
            
            .cert-body-text {
                font-size: 0.85em;
                max-width: 90%;
            }
            
            .cert-footer { 
                flex-direction: column; 
                gap: 2rem;
                margin-top: 20px;
            }
            
            .signature-upload-container { 
                grid-template-columns: 1fr; 
            }
            
            .certificate-wrapper {
                aspect-ratio: 1.414 / 1;
                max-width: 100%;
            }
            
            .verify-box {
                padding: 1.5rem;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            
            .certificate-wrapper, .certificate-wrapper * {
                visibility: visible;
            }
            
            .certificate-wrapper {
                position: absolute;
                left: 0;
                top: 0;
                width: 297mm;
                height: 210mm;
                max-width: none;
                page-break-inside: avoid;
            }
            
            @page {
                size: A4 landscape;
                margin: 0;
            }
        }
    </style>
</head>
<body>

    <!-- Login View -->
    <div id="loginView" class="login-container">
        <div class="login-box">
            <h2>üéì Sistema MST Certifica</h2>
            <p style="text-align: center; color: #666; margin-bottom: 2rem;">Acceso Administrativo</p>
            <form id="loginForm">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="loginUsername" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="loginPassword" placeholder="admin123" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Iniciar Sesi√≥n</button>
                <p style="margin-top: 1rem; text-align: center; font-size: 0.9rem; color: #999;">
                    Usuario demo: admin / admin123
                </p>
            </form>
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #ddd; text-align: center;">
                <p style="color: #666; margin-bottom: 1rem;">¬øTienes un certificado?</p>
                <button class="btn btn-secondary" onclick="goToVerify()" style="width: 100%;">Verificar Certificado</button>
            </div>
        </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboardView" class="hidden">
        <div class="header">
            <h1>üéì MST CERTIFICA</h1>
            <div class="user-info">
                <span id="usernameDisplay">Admin</span>
                <button class="btn btn-danger" onclick="logout()">Salir</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('students')">Alumnos</button>
                <button class="nav-tab" onclick="showTab('certificates')">Certificados</button>
                <button class="nav-tab" onclick="showTab('issued')">Emitidos</button>
            </div>

            <!-- Students Tab -->
            <div id="studentsTab" class="tab-content">
                <div class="card">
                    <h3>Agregar Alumno</h3>
                    <form id="studentForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Nombre Completo *</label>
                                <input type="text" id="studentName" required>
                            </div>
                            <div class="form-group">
                                <label>DNI *</label>
                                <input type="text" id="studentDNI" required>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="studentEmail">
                            </div>
                            <div class="form-group">
                                <label>Curso</label>
                                <input type="text" id="studentCourse">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Agregar Alumno</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Importar desde Excel</h3>
                    <div class="file-upload-zone" onclick="document.getElementById('excelFile').click()">
                        <p>üìÑ Haz clic para subir archivo Excel</p>
                        <p style="font-size: 0.9rem; color: #666;">Columnas: NOMBRE, DNI</p>
                        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display: none;" onchange="importExcel()">
                    </div>
                </div>

                <div class="card">
                    <h3>Lista de Alumnos</h3>
                    <table id="studentsTable">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>DNI</th>
                                <th>Email</th>
                                <th>Curso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #999;">No hay alumnos</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Certificates Tab -->
            <div id="certificatesTab" class="tab-content hidden">
                <div class="card">
                    <h3>Firmas (PNG)</h3>
                    <div class="signature-upload-container">
                        <div class="signature-upload-box">
                            <h4>Firma Director</h4>
                            <input type="file" id="signature1File" accept="image/png,image/jpeg,image/jpg" style="display: none;" onchange="loadSignature(1)">
                            <button class="btn btn-secondary" onclick="document.getElementById('signature1File').click()">Cargar Imagen</button>
                            <img id="signature1Preview" class="signature-preview hidden" alt="Firma 1">
                            <button class="btn btn-danger" style="margin-top: 0.5rem; display: none;" id="removeSign1" onclick="removeSignature(1)">Eliminar</button>
                        </div>
                        <div class="signature-upload-box">
                            <h4>Firma Coordinador</h4>
                            <input type="file" id="signature2File" accept="image/png,image/jpeg,image/jpg" style="display: none;" onchange="loadSignature(2)">
                            <button class="btn btn-secondary" onclick="document.getElementById('signature2File').click()">Cargar Imagen</button>
                            <img id="signature2Preview" class="signature-preview hidden" alt="Firma 2">
                            <button class="btn btn-danger" style="margin-top: 0.5rem; display: none;" id="removeSign2" onclick="removeSignature(2)">Eliminar</button>
                        </div>
                    </div>
                    <p style="color: #666; font-size: 0.9rem;">
                        üí° Arrastra las firmas en la vista previa para posicionarlas
                    </p>
                </div>

                <div class="card">
                    <h3>Configuraci√≥n</h3>
                    <form id="certConfigForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>T√≠tulo</label>
                                <input type="text" id="certTitle" value="CERTIFICADO DE LOGRO">
                            </div>
                            <div class="form-group">
                                <label>Subt√≠tulo</label>
                                <input type="text" id="certSubtitle" value="Se otorga este reconocimiento a:">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Cuerpo del Texto</label>
                            <textarea id="certBody" rows="3">Por su participaci√≥n y conclusi√≥n exitosa del programa de capacitaci√≥n, demostrando un compromiso inigualable con la excelencia y el desarrollo profesional.</textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Firmante 1 - Nombre</label>
                                <input type="text" id="sign1Name" value="Dr. J. K. Doe">
                            </div>
                            <div class="form-group">
                                <label>Firmante 1 - Cargo</label>
                                <input type="text" id="sign1Title" value="Director Ejecutivo">
                            </div>
                            <div class="form-group">
                                <label>Firmante 2 - Nombre</label>
                                <input type="text" id="sign2Name" value="Prof. A. Smith">
                            </div>
                            <div class="form-group">
                                <label>Firmante 2 - Cargo</label>
                                <input type="text" id="sign2Title" value="Coordinador del Programa">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="certDate">
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h3>Generar Certificados</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="generateBatchCertificates()">Generar Todos</button>
                        <button class="btn btn-secondary" onclick="showCertificatePreview()">Vista Previa</button>
                    </div>
                    <p style="margin-top: 1rem; color: #666;">
                        Total: <strong id="studentCount">0</strong> certificados
                    </p>
                </div>

                <div id="certificatePreview" class="hidden">
                    <div class="card">
                        <h3>Vista Previa</h3>
                        <p style="color: #666; margin-bottom: 1rem;">Arrastra las firmas para posicionarlas</p>
                        <div id="certificateContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Issued Tab -->
            <div id="issuedTab" class="tab-content hidden">
                <div class="card">
                    <h3>Enlace de Verificaci√≥n</h3>
                    <div class="verification-link-box">
                        <h4 style="margin-bottom: 1rem;">Enlace √önico para Todos</h4>
                        <p style="color: #666; margin-bottom: 1rem;">Los alumnos ingresar√°n su DNI para ver su certificado</p>
                        <input type="text" id="verificationLink" readonly onclick="this.select()">
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="copyVerificationLink()">Copiar Enlace</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Certificados Emitidos</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Alumno</th>
                                <th>DNI</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="issuedTableBody">
                            <tr>
                                <td colspan="4" style="text-align: center; color: #999;">No hay certificados</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Verify View -->
    <div id="verifyView" class="hidden">
        <div class="verify-container">
            <div class="verify-box">
                <h2>üîê Verificar Certificado</h2>
                <p>Ingrese su DNI para ver su certificado</p>
                
                <form id="verifyForm">
                    <div class="form-group">
                        <label>N√∫mero de DNI</label>
                        <input type="text" id="verifyDNI" placeholder="12345678" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Ver Certificado</button>
                </form>

                <div id="verifyResult" class="hidden"></div>

                <button class="btn btn-secondary" onclick="backToLogin()" style="width: 100%; margin-top: 1rem;">Volver</button>
            </div>
        </div>
    </div>

    <script>
        let students = [];
        let certificates = [];
        let currentUser = null;
        let signatureImages = { sign1: null, sign2: null };
        let signaturePositions = { sign1: { x: 0, y: -90 }, sign2: { x: 0, y: -90 } };

        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            document.getElementById('certDate').valueAsDate = new Date();
            updateStudentCount();
            updateVerificationLink();

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('verify')) {
                showView('verify');
            }
        });

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            if (username === 'admin' && password === 'admin123') {
                currentUser = { username: 'admin', role: 'admin' };
                document.getElementById('usernameDisplay').textContent = username;
                showView('dashboard');
            } else {
                alert('Credenciales incorrectas');
            }
        });

        function logout() {
            currentUser = null;
            showView('login');
        }

        function showView(view) {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('verifyView').classList.add('hidden');

            if (view === 'login') {
                document.getElementById('loginView').classList.remove('hidden');
            } else if (view === 'dashboard') {
                document.getElementById('dashboardView').classList.remove('hidden');
            } else if (view === 'verify') {
                document.getElementById('verifyView').classList.remove('hidden');
            }
        }

        function goToVerify() {
            showView('verify');
        }

        function showTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));

            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.remove('hidden');

            if (tab === 'certificates') {
                updateStudentCount();
            } else if (tab === 'issued') {
                renderIssuedCertificates();
            }
        }

        function loadSignature(num) {
            const file = document.getElementById('signature' + num + 'File').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                signatureImages['sign' + num] = e.target.result;
                document.getElementById('signature' + num + 'Preview').src = e.target.result;
                document.getElementById('signature' + num + 'Preview').classList.remove('hidden');
                document.getElementById('removeSign' + num).style.display = 'inline-block';
                saveToStorage();
            };
            reader.readAsDataURL(file);
        }

        function removeSignature(num) {
            signatureImages['sign' + num] = null;
            document.getElementById('signature' + num + 'Preview').classList.add('hidden');
            document.getElementById('signature' + num + 'File').value = '';
            document.getElementById('removeSign' + num).style.display = 'none';
            saveToStorage();
        }

        function makeDraggable(element, signKey) {
            let isDragging = false;
            let startX, startY, initialX, initialY;

            element.addEventListener('mousedown', function(e) {
                isDragging = true;
                element.classList.add('dragging');
                startX = e.clientX;
                startY = e.clientY;
                const transform = element.style.transform;
                const match = transform.match(/translate\(([^,]+)px,\s*([^)]+)px\)/);
                initialX = match ? parseFloat(match[1]) : 0;
                initialY = match ? parseFloat(match[2]) : signaturePositions[signKey].y;
                e.preventDefault();
            });

            element.addEventListener('touchstart', function(e) {
                isDragging = true;
                element.classList.add('dragging');
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                const transform = element.style.transform;
                const match = transform.match(/translate\(([^,]+)px,\s*([^)]+)px\)/);
                initialX = match ? parseFloat(match[1]) : 0;
                initialY = match ? parseFloat(match[2]) : signaturePositions[signKey].y;
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                const newX = initialX + dx;
                const newY = initialY + dy;
                element.style.transform = 'translate(' + newX + 'px, ' + newY + 'px) translateX(-50%)';
                signaturePositions[signKey] = { x: newX, y: newY };
            });

            document.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                const touch = e.touches[0];
                const dx = touch.clientX - startX;
                const dy = touch.clientY - startY;
                const newX = initialX + dx;
                const newY = initialY + dy;
                element.style.transform = 'translate(' + newX + 'px, ' + newY + 'px) translateX(-50%)';
                signaturePositions[signKey] = { x: newX, y: newY };
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    element.classList.remove('dragging');
                    saveToStorage();
                }
            });

            document.addEventListener('touchend', function() {
                if (isDragging) {
                    isDragging = false;
                    element.classList.remove('dragging');
                    saveToStorage();
                }
            });
        }

        document.getElementById('studentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const student = {
                id: Date.now(),
                nombre: document.getElementById('studentName').value,
                dni: document.getElementById('studentDNI').value,
                email: document.getElementById('studentEmail').value || '',
                curso: document.getElementById('studentCourse').value || ''
            };

            students.push(student);
            saveToStorage();
            renderStudentsTable();
            this.reset();
            alert('Alumno agregado exitosamente');
        });

        function renderStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No hay alumnos</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(function(s) {
                return '<tr><td>' + s.nombre + '</td><td>' + s.dni + '</td><td>' + s.email + '</td><td>' + s.curso + '</td><td><button class="btn btn-danger" style="padding: 0.4rem 0.8rem;" onclick="deleteStudent(' + s.id + ')">Eliminar</button></td></tr>';
            }).join('');
        }

        function deleteStudent(id) {
            if (confirm('¬øEliminar este alumno?')) {
                students = students.filter(function(s) { return s.id !== id; });
                saveToStorage();
                renderStudentsTable();
            }
        }

        function importExcel() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);

                let imported = 0;
                json.forEach(function(row) {
                    const nombre = row.NOMBRE || row.Nombre || row.nombre || row.APELLIDOS || '';
                    const dni = row.DNI || row.dni || row.DOCUMENTO || row.documento || '';

                    if (nombre && dni) {
                        students.push({
                            id: Date.now() + Math.random(),
                            nombre: nombre.toString(),
                            dni: dni.toString(),
                            email: row.EMAIL || row.email || '',
                            curso: row.CURSO || row.curso || ''
                        });
                        imported++;
                    }
                });

                saveToStorage();
                renderStudentsTable();
                alert('Se importaron ' + imported + ' alumnos');
            };
            reader.readAsArrayBuffer(file);
        }

        function updateStudentCount() {
            document.getElementById('studentCount').textContent = students.length;
        }

        function generateBatchCertificates() {
            if (students.length === 0) {
                alert('No hay alumnos registrados');
                return;
            }

            if (!confirm('¬øGenerar ' + students.length + ' certificados?')) return;

            const config = getCertificateConfig();
            certificates = [];

            students.forEach(function(student) {
                certificates.push({
                    studentId: student.id,
                    studentName: student.nombre,
                    studentDNI: student.dni,
                    date: new Date().toISOString(),
                    config: config
                });
            });

            saveToStorage();
            alert('‚úì ' + certificates.length + ' certificados generados');
            showTab('issued');
        }

        function getCertificateConfig() {
            return {
                title: document.getElementById('certTitle').value,
                subtitle: document.getElementById('certSubtitle').value,
                body: document.getElementById('certBody').value,
                sign1Name: document.getElementById('sign1Name').value,
                sign1Title: document.getElementById('sign1Title').value,
                sign2Name: document.getElementById('sign2Name').value,
                sign2Title: document.getElementById('sign2Title').value,
                date: document.getElementById('certDate').value,
                sign1Image: signatureImages.sign1,
                sign2Image: signatureImages.sign2,
                sign1Position: signaturePositions.sign1,
                sign2Position: signaturePositions.sign2
            };
        }

        function showCertificatePreview() {
            if (students.length === 0) {
                alert('No hay alumnos para previsualizar');
                return;
            }

            const config = getCertificateConfig();
            const student = students[0];

            document.getElementById('certificatePreview').classList.remove('hidden');
            renderCertificate(student.nombre, config, 'preview', 'certificateContainer');
        }

        function renderCertificate(studentName, config, certId, containerId) {
            const container = document.getElementById(containerId);

            const dateObj = new Date(config.date);
            const formattedDate = dateObj.toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            const sign1Html = config.sign1Image ? '<img src="' + config.sign1Image + '" class="signature-image" id="sign1-' + certId + '" style="transform: translate(' + config.sign1Position.x + 'px, ' + config.sign1Position.y + 'px) translateX(-50%);" alt="Firma 1">' : '';
            const sign2Html = config.sign2Image ? '<img src="' + config.sign2Image + '" class="signature-image" id="sign2-' + certId + '" style="transform: translate(' + config.sign2Position.x + 'px, ' + config.sign2Position.y + 'px) translateX(-50%);" alt="Firma 2">' : '';

            container.innerHTML = '<div class="certificate-wrapper" id="cert-' + certId + '"><div class="cert-company-name">MST CERTIFICA</div><h1 class="cert-title">' + config.title + '</h1><div class="cert-subtitle">' + config.subtitle + '</div><div class="cert-recipient">' + studentName + '</div><p class="cert-body-text">' + config.body + '</p><div class="cert-footer"><div class="cert-signature-block">' + sign1Html + '<div class="signature-line"></div><div class="signature-name">' + config.sign1Name + '</div><div class="signature-title">' + config.sign1Title + '</div></div><div class="cert-signature-block">' + sign2Html + '<div class="signature-line"></div><div class="signature-name">' + config.sign2Name + '</div><div class="signature-title">' + config.sign2Title + '</div><div class="signature-title" style="margin-top: 5px;">' + formattedDate + '</div></div></div><div class="cert-qr-block"><div id="qrcode-' + certId + '"></div><div class="qr-label">Verificar</div></div></div>';

            setTimeout(function() {
                const verifyUrl = window.location.origin + window.location.pathname + '?verify';
                generateQR(verifyUrl, 'qrcode-' + certId);

                if (certId === 'preview') {
                    const sign1El = document.getElementById('sign1-' + certId);
                    const sign2El = document.getElementById('sign2-' + certId);
                    if (sign1El) makeDraggable(sign1El, 'sign1');
                    if (sign2El) makeDraggable(sign2El, 'sign2');
                }
            }, 100);
        }

        function generateQR(url, elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.innerHTML = '';
            new QRCode(element, {
                text: url,
                width: 80,
                height: 80,
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function updateVerificationLink() {
            const link = window.location.origin + window.location.pathname + '?verify';
            document.getElementById('verificationLink').value = link;
        }

        function copyVerificationLink() {
            const input = document.getElementById('verificationLink');
            input.select();
            document.execCommand('copy');
            alert('‚úì Enlace copiado');
        }

        function renderIssuedCertificates() {
            const tbody = document.getElementById('issuedTableBody');
            if (certificates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No hay certificados</td></tr>';
                return;
            }

            tbody.innerHTML = certificates.map(function(cert) {
                const date = new Date(cert.date).toLocaleDateString('es-ES');
                return '<tr><td>' + cert.studentName + '</td><td>' + cert.studentDNI + '</td><td>' + date + '</td><td><span style="color: var(--success-color); font-weight: 600;">‚úì Activo</span></td></tr>';
            }).join('');
        }

        document.getElementById('verifyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const dni = document.getElementById('verifyDNI').value.trim();
            const resultDiv = document.getElementById('verifyResult');

            const cert = certificates.find(function(c) { return c.studentDNI === dni; });

            if (!cert) {
                resultDiv.innerHTML = '<div class="alert alert-danger">‚ùå Certificado no encontrado</div>';
                resultDiv.classList.remove('hidden');
                return;
            }

            const dateStr = new Date(cert.date).toLocaleDateString('es-ES');
            resultDiv.innerHTML = '<div class="alert alert-success">‚úì Certificado verificado</div><div class="certificate-info"><p><strong>Nombre:</strong> ' + cert.studentName + '</p><p><strong>DNI:</strong> ' + cert.studentDNI + '</p><p><strong>Fecha:</strong> ' + dateStr + '</p></div><div id="verifiedCertContainer" style="margin-top: 2rem;"></div><div class="btn-group"><button class="btn btn-primary" onclick="downloadCertificate(\'' + cert.studentDNI + '\')">üì• Descargar</button><button class="btn btn-secondary" onclick="printCertificate(\'' + cert.studentDNI + '\')">üñ®Ô∏è Imprimir</button></div>';
            resultDiv.classList.remove('hidden');

            setTimeout(function() {
                renderCertificate(cert.studentName, cert.config, cert.studentDNI, 'verifiedCertContainer');
            }, 100);
        });

        function downloadCertificate(dni) {
            const element = document.getElementById('cert-' + dni);
            if (!element) {
                alert('Error al generar el certificado');
                return;
            }

            html2canvas(element, {
                scale: 3,
                backgroundColor: '#ffffff',
                logging: false
            }).then(function(canvas) {
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Certificado_' + dni + '.png';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            });
        }

        function printCertificate(dni) {
            const element = document.getElementById('cert-' + dni);
            if (!element) {
                alert('Error al imprimir');
                return;
            }

            window.print();
        }

        function backToLogin() {
            showView('login');
            document.getElementById('verifyForm').reset();
            document.getElementById('verifyResult').innerHTML = '';
            document.getElementById('verifyResult').classList.add('hidden');
        }

        function saveToStorage() {
            localStorage.setItem('mst_students', JSON.stringify(students));
            localStorage.setItem('mst_certificates', JSON.stringify(certificates));
            localStorage.setItem('mst_signatures', JSON.stringify(signatureImages));
            localStorage.setItem('mst_signature_positions', JSON.stringify(signaturePositions));
        }

        function loadFromStorage() {
            const savedStudents = localStorage.getItem('mst_students');
            const savedCerts = localStorage.getItem('mst_certificates');
            const savedSignatures = localStorage.getItem('mst_signatures');
            const savedPositions = localStorage.getItem('mst_signature_positions');

            if (savedStudents) {
                students = JSON.parse(savedStudents);
                renderStudentsTable();
            }

            if (savedCerts) {
                certificates = JSON.parse(savedCerts);
            }

            if (savedSignatures) {
                signatureImages = JSON.parse(savedSignatures);
                if (signatureImages.sign1) {
                    document.getElementById('signature1Preview').src = signatureImages.sign1;
                    document.getElementById('signature1Preview').classList.remove('hidden');
                    document.getElementById('removeSign1').style.display = 'inline-block';
                }
                if (signatureImages.sign2) {
                    document.getElementById('signature2Preview').src = signatureImages.sign2;
                    document.getElementById('signature2Preview').classList.remove('hidden');
                    document.getElementById('removeSign2').style.display = 'inline-block';
                }
            }

            if (savedPositions) {
                signaturePositions = JSON.parse(savedPositions);
            }
        }
    </script>
</body>
</html>
